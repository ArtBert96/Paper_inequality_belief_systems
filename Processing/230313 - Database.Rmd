---
title: "221220 - Database"
output: html_document
date: "2022-12-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Input

```{r}
#Libraries
library(pacman)
p_load(tidyverse, janitor, here, haven, labelled, sjmisc, skimr,
       stargazer, purr, conflicted, biclust, corclass, poLCA)

```

```{r}
#Packages conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")

options(max.print=999999)
options(scipen=999)
```

## ISSP Social Inequality 2019

```{r}
#Load database
issp_2019_original = read_dta(here("Input", "issp_social_inequality_2019", "ZA7600_v3-0-0.dta"))  %>% 
  clean_names()

#Missing values and inverting polarity
issp_2019 = issp_2019_original %>% 
  mutate(across(studyno:partials, ~replace(., .<0 , NA)))
         
```

```{r}
#Original variables
frq(issp_2019, sex, age, marital, partliv, work, mainstat, educyrs, degree, party_lr, urbrural)

#Gender
issp_2019_original = issp_2019_original %>% 
  mutate(gender = case_when(sex==1 ~ 0,
                            sex==2 ~ 1))

issp_2019_original$gender = factor(issp_2019_original$gender, 
                      levels = c(0:1), 
                      labels = c("Male",
                                 "Female"))

#Age


#Family status
issp_2019_original = issp_2019_original %>% 
  mutate(married = ifelse(marital <= 2, 1, 0))

issp_2019_original$married = factor(issp_2019_original$married, 
                      levels = c(0:1), 
                      labels = c("Non married",
                                 "Married"))


#Employment
issp_2019_original = issp_2019_original %>% 
  mutate(work_status_ = as.numeric(mainstat)) %>% 
  mutate(work_status = case_when(work_status_<=2 ~ NA_real_,
                                 work_status_==5 | work_status_==6 | work_status_==7 | work_status_==8 | 
                                   work_status_==10 | work_status_==11 ~ 0,
                                 work_status_==4 ~ 1,
                                 work_status_==3 | work_status_==9 ~ 2))

issp_2019_original$work_status = factor(issp_2019_original$work_status, 
                      levels = c(0:2), 
                      labels = c("Out of workforce",
                                 "Unemployed",
                                 "Employed"))

#Education
issp_2019_original = issp_2019_original %>% 
  mutate(education_ = as.numeric(degree)) %>% 
  mutate(education = case_when(education_==1 ~ NA_real_,
                               education_==2 | education_==3 ~ 0,
                               education_==4 ~ 1,
                               education_==5 | education_==6 ~ 2,
                               education_>=7 ~ 3))

issp_2019_original$education = factor(issp_2019_original$education, 
                      levels = c(0:3), 
                      labels = c("Primary",
                                 "Lower secondary",
                                 "Upper secondary",
                                 "Tertiary"))


#Zone
issp_2019_original = issp_2019_original %>% 
  mutate(zone_ = as.numeric(urbrural)) %>%
  mutate(zone = case_when(zone_==1 ~ NA_real_,
                          zone_==2 | zone_==3 | zone_==4 ~ 1,
                          zone_>=5 ~ 0))

issp_2019_original$zone = factor(issp_2019_original$zone, 
                      levels = c(0:1), 
                      labels = c("Rural",
                                 "Urban"))

#Control variables
frq(issp_2019_original, gender, age, married, work_status, education, zone)
```

# Processing

## Complete database

```{r}
#Select
issp_2019 = issp_2019_original %>% 
  filter(country==840) %>% 
  select(studyno:educyrs, degree:union, isco08, it_inc, caseid:partials)

#Rename
issp_2019 = issp_2019 %>% 
  rename(ib_weafam = v1,
          ib_edupar = v2,
          ib_edu = v3,
          ib_work = v4,
          ib_people = v5,
          ib_pol = v6,
          ib_bribes = v7,
          ib_race = v8,
          ib_relig = v9,
          ib_sex = v10,
          ineq_per = v21,
          red_pub = v22,
          red_pri = v24,
          ineq_jud = v50,
          red_unca = v26,
          red_unsu = v27,
          tax_bel = v28,
          tax_per = v29,
          ineq_ang = v32,
          pay_resp = v44,
          pay_educ = v45,
          pay_need = v46,
          pay_merit = v47)

#Reorder
issp_2019 = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_"),
         starts_with("pay_"),
         everything())

```


```{r}



#Reorder
issp_2019 = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_"),
         starts_with("pay_"),
         everything())

```


## Attitudes towards inequality database

```{r}

#Select and listwise
ITA_net = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_"),
         starts_with("pay_")) %>% 
  na.omit()

names(ITA_net)

```

## T-test

```{r}
#loop each V and run t.test
tests_list <- lapply(seq_along(W3_full), function(i){
  t.test(W3_full[[i]], W3_full_nolist[[i]])
})

means = sapply(tests_list, '[[', 'statistic')
pvalues = as.data.frame(sapply(tests_list, '[[', 'p.value')) 
cis = sapply(tests_list, '[[', 'conf.int')

#print true when the means differ
pvalues[,2] = names(W3_full)
pvalues[,3] = with(pvalues,pvalues<0.05)
```


## Summary

```{r}
#ITA_net
summary_ITA_net  = ITA_net %>% 
  skim() %>% 
  as.data.frame()

stargazer(as.data.frame(ITA_net), type = "text", nobs = TRUE)

#CAN
summary_can  = as.data.frame(skim(ITA_net_can))
stargazer(as.data.frame(ITA_net_can), type = "text", nobs = TRUE)

```

# Output

```{r}
#ITA_net
write.csv(ITA_net,"../Input/ITA.csv", row.names = FALSE)

#NCTs
dir.create("../Input/NCT")

write.csv(income_0,"../Input/NCT/income0.csv", row.names = FALSE)
write.csv(income_1,"../Input/NCT/income1.csv", row.names = FALSE)

write.csv(edu_0,"../Input/NCT/edu0.csv", row.names = FALSE)
write.csv(edu_1,"../Input/NCT/edu1.csv", row.names = FALSE)

write.csv(egpclass_0,"../Input/NCT/egpclass0.csv", row.names = FALSE)
write.csv(egpclass_1,"../Input/NCT/egpclass1.csv", row.names = FALSE)

write.csv(subclass_0,"../Input/NCT/subclass0.csv", row.names = FALSE)
write.csv(subclass_1,"../Input/NCT/subclass1.csv", row.names = FALSE)

write.csv(socmob_0,"../Input/NCT/socmob0.csv", row.names = FALSE)
write.csv(socmob_1,"../Input/NCT/socmob1.csv", row.names = FALSE)

#CAN
saveRDS(ITA_net_can, here("Input", "ITA_net_can.rds"))
```


